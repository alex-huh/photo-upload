AWSTemplateFormatVersion: '2010-09-09'
Description: photo-upload
Transform:
- AWS::Serverless-2016-10-31
Resources:
  RecordPhotoBucket:
    Type: AWS::S3::Bucket
    Properties:
      BucketName: 54vv-record-photos
      CorsConfiguration:
        CorsRules:
        - AllowedOrigins:
          - http://localhost:5173
          AllowedMethods:
          - PUT
          - GET
          - HEAD
          AllowedHeaders:
          - '*'
          ExposedHeaders:
          - ETag
          MaxAge: 3000
  GenerateUploadUrlFunction:
    Type: AWS::Serverless::Function
    Properties:
      Handler: generateUploadURL.lambdaHandler
      CodeUri: GenerateUploadUrlFunction
      Runtime: nodejs22.x
      Architectures:
      - x86_64
      Environment:
        Variables:
          BUCKET_NAME:
            Ref: RecordPhotoBucket
      Policies:
      - S3CrudPolicy:
          BucketName:
            Ref: RecordPhotoBucket
      Events:
        UploadUrlApi:
          Type: Api
          Properties:
            Path: /generate-upload-url
            Method: POST
        UploadUrlOptions:
          Type: Api
          Properties:
            Path: /generate-upload-url
            Method: OPTIONS
    Metadata:
      SamResourceId: GenerateUploadUrlFunction
  ListPhotosFunction:
    Type: AWS::Serverless::Function
    Properties:
      Handler: listPhotos.lambdaHandler
      CodeUri: ListPhotosFunction
      Runtime: nodejs22.x
      Architectures:
      - x86_64
      Environment:
        Variables:
          BUCKET_NAME:
            Ref: RecordPhotoBucket
      Policies:
      - S3ReadPolicy:
          BucketName:
            Ref: RecordPhotoBucket
      Events:
        ListPhotosApi:
          Type: Api
          Properties:
            Path: /list-images
            Method: GET
          Cors:
            AllowMethods: '''GET,OPTIONS'''
            AllowHeaders: '''*'''
            AllowOrigin: '''http://localhost:5173'''
        ListPhotosOptions:
          Type: Api
          Properties:
            Path: /list-images
            Method: OPTIONS
    Metadata:
      SamResourceId: ListPhotosFunction
Outputs:
  GenerateUploadUrlEndpoint:
    Description: API Gateway endpoint for generating S3 pre-signed upload URLs
    Value:
      Fn::Sub: https://${ServerlessRestApi}.execute-api.${AWS::Region}.amazonaws.com/Prod/generate-upload-url
  ListPhotosEndpoint:
    Description: API Gateway endpoint for generating S3 pre-signed download URLs
    Value:
      Fn::Sub: https://${ServerlessRestApi}.execute-api.${AWS::Region}.amazonaws.com/Prod/list-images
